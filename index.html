<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Formular ausfüllen</title>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    :root{color-scheme:light dark}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,sans-serif;margin:0;display:grid;place-items:start center;padding:2rem;gap:1rem}
    .card{width:min(860px,95vw);border:1px solid #ccc;border-radius:14px;padding:1rem 1.25rem;box-shadow:0 6px 24px rgba(0,0,0,.08);background:Canvas}
    h1{margin:.25rem 0 1rem 0;font-size:1.35rem}
    form{display:grid;gap:.75rem}
    label{font-weight:600}
    input,select,button{font:inherit;padding:.6rem .7rem;border-radius:10px;border:1px solid #bbb;background:Canvas}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    button{cursor:pointer;border:none;background:#2563eb;color:#fff;font-weight:700}
    button:disabled{opacity:.6;cursor:not-allowed}
    .msg{
      margin-top:1rem;
      padding:.75rem 1rem;
      border-radius:10px;
      font-weight:600;
      text-align:center;
      border:2px solid transparent;
      transition:all .2s ease;
    }
    .msg.ok{
      background:#ecfdf5;
      color:#065f46;
      border-color:#6ee7b7;
      box-shadow:0 3px 8px rgba(6,95,70,0.15);
    }
    .msg.err{
      background:#fef2f2;
      color:#991b1b;
      border-color:#fca5a5;
      box-shadow:0 3px 8px rgba(153,27,27,0.15);
    }
    details.guideline{width:min(860px,95vw)}
    details.guideline > summary{
      list-style:none; cursor:pointer; display:flex; align-items:center; gap:.5rem;
      font-weight:700; padding:.8rem 1rem; border:1px solid #ccc; border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,.08);
      background:Canvas;
    }
    details.guideline[open] > summary{border-bottom-left-radius:0;border-bottom-right-radius:0}
    .caret{width:1rem;height:1rem;transition:transform .2s ease}
    details.guideline[open] .caret{transform:rotate(90deg)}
    .guide-body{border:1px solid #ccc;border-top:none;border-bottom-left-radius:14px;border-bottom-right-radius:14px;padding:1rem;background:Canvas}
    .guide-body p{margin:.4rem 0}
    .guide-body a{color:inherit;text-decoration:underline}
    .muted{opacity:.8}
    ol{margin:.2rem 0 .2rem 1.2rem}
    .coffee{
      margin-top:1rem;text-align:center;
    }
    .coffee a{
      display:inline-flex;align-items:center;gap:.5rem;
      background:#ffdd00;color:#000;text-decoration:none;
      font-weight:700;padding:.6rem 1.2rem;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.1);
      transition:transform .15s ease,box-shadow .15s ease;
    }
    .coffee a:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,.15)}
  </style>
</head>
<body>
<details class="guideline">
  <summary>
    <svg class="caret" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5l8 7-8 7" fill="currentColor"/></svg>
    Guideline
  </summary>
  <div class="guide-body">
    <p>Dieses Tool generiert Ihnen einen Vorschlag für einen Kündigungsbrief falls Sie Ihre Grundversicherung wechseln möchten.</p>
    <p>Falls Sie Ihre Krankenkasse noch nicht gekündigt haben, können Sie sich auf
      <a href="https://www.priminfo.admin.ch/de/praemien" target="_blank" rel="noopener">Priminfo</a> informieren.
      Das folgende Video zeigt Ihnen, wie Sie auf der Seite navigieren:
    </p>

    <video controls preload="metadata" playsinline style="width:100%;border-radius:12px;margin:.5rem 0 0.75rem 0">
      <source src="./priminfo_guide.webm" type="video/webm">
      <source src="./priminfo_guide.mp4" type="video/mp4">
      <a href="./priminfo_guide.webm">Download Video</a>
    </video>

    <p class="muted">Alle Informationen stammen aus öffentlicher Hand und werden hier ohne Gewähr weitergegeben:</p>
    <ol class="muted">
      <li>Quelle Template:
        <a href="https://www.priminfo.admin.ch/downloads/08_Kuendigung%20(Grundversicherung)_interaktiv_ACC_send.pdf" target="_blank" rel="noopener">priminfo.admin.ch – Kündigung (Grundversicherung)</a>
      </li>
      <li>Quelle Krankenkassenadressen:
        <a href="https://www.priminfo.admin.ch/downloads/Verzeichnis%20zugelassene%20Krankenversicherer_Sept.%202025.pdf" target="_blank" rel="noopener">priminfo.admin.ch – Verzeichnis zugelassene Krankenversicherer</a>
      </li>
      <li>Quelle Krankenkassenvergleich:
        <a href="https://www.priminfo.admin.ch/de/praemien" target="_blank" rel="noopener">priminfo.admin.ch – Prämien</a>
      </li>
    </ol>
  </div>
</details>

  <div class="card">
    <h1>PDF Formular ausfüllen</h1>
    <form id="f">
      <div class="row">
        <div>
          <label for="vn">Versicherten Nummer</label>
          <input id="vn" required />
        </div>
        <div>
          <label for="kk">Krankenkasse</label>
          <select id="kk" required><option value="" disabled selected>Bitte wählen…</option></select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="name">Name</label>
          <input id="name" required />
        </div>
        <div>
          <label for="vorname">Vorname</label>
          <input id="vorname" required />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="strasse">Strasse, Nummer</label>
          <input id="strasse" required />
        </div>
        <div>
          <label for="plzort">Postleitzahl, Ort</label>
          <input id="plzort" required />
        </div>
      </div>
      <div style="display:flex;align-items:end;justify-content:end">
        <button id="gen" type="submit">PDF erstellen</button>
      </div>
    </form>
    <div id="msg" class="msg ok"></div>
    <div class="coffee">
      <a href="https://buymeacoffee.com/janeinvielleicht" target="_blank" rel="noopener">
        ☕ Buy me a coffee
      </a>
    </div>
  </div>

<script>
const csvUrl = './kk_addressen.csv';
const pdfTemplateUrl = './grundversicherung_Kuendigung_template.pdf';
const $ = id => document.getElementById(id);
function setMsg(t,err){
  const m = $('msg');
  if(!m){console[err?'error':'log'](t);return;}
  m.textContent = t;
  m.className = 'msg ' + (err ? 'err' : 'ok');
  m.style.display = 'block';
  m.scrollIntoView({behavior:'smooth',block:'center'});
}

async function loadCSV(){
  try{
    const res = await fetch(csvUrl,{cache:'no-cache'}); if(!res.ok){setMsg('CSV nicht gefunden',true);return}
    const text = await res.text();
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
    if(!lines.length){setMsg('CSV ist leer',true);return}
    const delim = lines[0].includes(';')?';':',';
    const header = lines[0].split(delim).map(h=>h.trim().toLowerCase());
    const nameIdx = header.findIndex(h=>['name','krankenkasse','kasse'].includes(h));
    if(nameIdx<0){setMsg('Spaltenkopf für Krankenkasse nicht gefunden',true);return}
    const sel = $('kk');
    for(let i=1;i<lines.length;i++){
      const cells = lines[i].split(delim).map(c=>c.trim());
      const v = cells[nameIdx];
      if(v){ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }
    }
  }catch(e){ setMsg('Fehler beim Laden der CSV',true); console.error(e) }
}

function todayCH(){
  const d = new Date();
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  return `${dd}.${mm}.${yyyy}`;
}

async function generatePDF(e){
  e.preventDefault(); $('gen').disabled = true;
  try{
    const buf = await fetch(pdfTemplateUrl,{cache:'no-cache'}).then(r=>{if(!r.ok)throw new Error('PDF nicht gefunden');return r.arrayBuffer()});
    const pdfDoc = await PDFLib.PDFDocument.load(buf);
    const form = pdfDoc.getForm();

    const inputs = {
      versichert: $('vn')?.value.trim() || '',
      kk:         $('kk')?.value.trim() || '',
      name:       $('name')?.value.trim() || '',
      vorname:    $('vorname')?.value.trim() || '',
      strasse:    $('strasse')?.value.trim() || '',
      plzort:     $('plzort')?.value.trim() || ''
    };

    const pairsExact = [
      ['Versicherten Nummer', inputs.versichert],
      ['Name der Krankenversicherung', inputs.kk],
      ['Name', inputs.name],
      ['Vorname', inputs.vorname],
      ['Strasse Nummer', inputs.strasse],
      ['Strasse Nummer_2', inputs.strasse],
      ['Postleitzahl Ort', inputs.plzort],
      ['Postleitzahl Wohnort', inputs.plzort],
      ['Name Vorname', inputs.name && inputs.vorname ? inputs.name + ', ' + inputs.vorname : ''],
      ['Ort Datum', todayCH()]
    ];

    let filled = 0;
    for(const [fieldName, value] of pairsExact){
      if(!value) continue;
      try{ form.getTextField(fieldName).setText(value); filled++; }
      catch(_){ console.warn('Feld nicht gefunden:', fieldName); }
    }

    if(filled===0){ setMsg('Keine Formularfelder gefunden. Ist das PDF evtl. XFA?', true); return }

    form.flatten();
    const bytes = await pdfDoc.save();
    const blob  = new Blob([bytes], { type: 'application/pdf' });
    const url   = URL.createObjectURL(blob);
    const a     = document.createElement('a');
    a.href = url; a.download = 'kuendigung.pdf';
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
    setMsg('PDF Erstellt! Jetzt können Sie das noch ausdrucken, unterschreiben und (ggf. per Einschreiben) abschicken!');
  }catch(err){
    setMsg('Fehler beim Erstellen der PDF', true);
    console.error(err);
  }finally{
    $('gen').disabled = false;
  }
}

if(location.hostname.includes('github.com')) setMsg('Bitte über GitHub Pages öffnen (Settings → Pages).',true);
loadCSV();
$('f').addEventListener('submit', generatePDF);
</script>
</body>
</html>

