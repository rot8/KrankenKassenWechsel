<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Formular ausfüllen</title>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    :root{color-scheme:light dark}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,sans-serif;margin:0;display:grid;place-items:start center;padding:2rem}
    .card{width:min(860px,95vw);border:1px solid #ccc;border-radius:14px;padding:1rem 1.25rem;box-shadow:0 6px 24px rgba(0,0,0,.08);background:Canvas}
    h1{margin:.25rem 0 1rem 0;font-size:1.35rem}
    form{display:grid;gap:.75rem}
    label{font-weight:600}
    input,select,button{font:inherit;padding:.6rem .7rem;border-radius:10px;border:1px solid #bbb;background:Canvas}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    button{cursor:pointer;border:none;background:#2563eb;color:#fff;font-weight:700}
    button:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:.5rem;font-size:.9rem}
    .err{color:#b91c1c}
    .ok{opacity:.7}
  </style>
</head>
<body>
  <div class="card">
    <h1>PDF Formular ausfüllen</h1>
    <form id="f">
      <div class="row">
        <div>
          <label for="vn">Versicherten Nummer</label>
          <input id="vn" required />
        </div>
        <div>
          <label for="kk">Krankenkasse</label>
          <select id="kk" required><option value="" disabled selected>Bitte wählen…</option></select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="name">Name</label>
          <input id="name" required />
        </div>
        <div>
          <label for="vorname">Vorname</label>
          <input id="vorname" required />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="strasse">Strasse, Nummer</label>
          <input id="strasse" required />
        </div>
        <div>
          <label for="plzort">Postleitzahl, Ort</label>
          <input id="plzort" required />
        </div>
      </div>
      <div class="row">
        <div style="display:flex;align-items:end;justify-content:end">
          <button id="gen" type="submit">PDF erstellen</button>
        </div>
      </div>
    </form>
    <div id="msg" class="msg ok"></div>
  </div>
<script>
const csvUrl='./kk_addressen.csv'
const pdfTemplateUrl='./grundversicherung_Kuendigung_template.pdf'
const $=id=>document.getElementById(id)
function setMsg(t,err){const m=$('msg');m.textContent=t;m.className='msg '+(err?'err':'ok')}

async function loadCSV(){
  try{
    const res=await fetch(csvUrl,{cache:'no-cache'}); if(!res.ok){setMsg('CSV nicht gefunden',true);return}
    const text=await res.text()
    const lines=text.split(/\r?\n/).filter(l=>l.trim().length)
    if(!lines.length){setMsg('CSV ist leer',true);return}
    const delim=lines[0].includes(';')?';':','
    const header=lines[0].split(delim).map(h=>h.trim().toLowerCase())
    const nameIdx=header.findIndex(h=>['name','krankenkasse','kasse'].includes(h))
    if(nameIdx<0){setMsg('Spaltenkopf für Krankenkasse nicht gefunden',true);return}
    const sel=$('kk')
    for(let i=1;i<lines.length;i++){
      const cells=lines[i].split(delim).map(c=>c.trim())
      const v=cells[nameIdx]
      if(v){const o=document.createElement('option');o.value=v;o.textContent=v;sel.appendChild(o)}
    }
  }catch(e){setMsg('Fehler beim Laden der CSV',true);console.error(e)}
}

function findTextField(form, name){
  try{ return form.getTextField(name) }catch(_){}
  const nL = name.toLowerCase()
  const cand = form.getFields().find(f => {
    const nm = String(f.getName()).toLowerCase()
    return nm===nL || nm.includes(nL)
  })
  if(!cand) return null
  try{ return form.getTextField(String(cand.getName())) }catch(_){ return null }
}

async function generatePDF(e){
  e.preventDefault(); $('gen').disabled=true
  try{
    const buf=await fetch(pdfTemplateUrl,{cache:'no-cache'}).then(r=>{if(!r.ok)throw new Error('PDF nicht gefunden');return r.arrayBuffer()})
    const pdfDoc=await PDFLib.PDFDocument.load(buf)
    const form=pdfDoc.getForm()

    const inputs={
      versichert:$('vn').value.trim(),
      kk:$('kk').value.trim(),
      name:$('name').value.trim(),
      vorname:$('vorname').value.trim(),
      strasse:$('strasse').value.trim(),
      plzort:$('plzort').value.trim()
    }

    const pairs = [
      ['Versicherten Nummer', inputs.versichert],
      ['Name der Krankenversicherung', inputs.kk],
      ['Name', inputs.name],
      ['Vorname', inputs.vorname],
      ['Strasse, Nummer', inputs.strasse],
      ['Postleitzahl, Ort', inputs.plzort],
      ['Name, Vorname', inputs.name ? (inputs.name+', '+inputs.vorname) : '']
    ]

    let filled = 0
    for(const [fieldName, value] of pairs){
      if(!value) continue
      const tf = findTextField(form, fieldName)
      if(tf){ tf.setText(value); filled++ } else { console.warn('Feld nicht gefunden:', fieldName) }
    }

    if(filled===0){ setMsg('Keine Formularfelder gefunden. Prüfe, ob das PDF XFA ist.', true); return }

    form.flatten()
    const bytes=await pdfDoc.save()
    const blob=new Blob([bytes],{type:'application/pdf'})
    const url=URL.createObjectURL(blob)
    const a=document.createElement('a')
    a.href=url
    a.download=($('filename').value.trim()||'kuendigung.pdf').replace(/\s+/g,'_')
    a.style.display='none'
    document.body.appendChild(a)
    a.click()
    setTimeout(()=>{URL.revokeObjectURL(url);a.remove()},100)
    setMsg('PDF erstellt')
  }catch(err){ setMsg('Fehler beim Erstellen der PDF',true); console.error(err) }
  finally{ $('gen').disabled=false }
}

if(location.hostname.includes('github.com')) setMsg('Bitte über GitHub Pages öffnen (Settings → Pages).',true)
loadCSV()
$('f').addEventListener('submit',generatePDF)
</script>
</body>
</html>

